<%- include('../layout', {
  title: title,
  body: `
    <div class="form-page">
      <h2>Edit Card</h2>
      <p style="font-size: 0.85rem; color: #94a3b8; margin-top: -0.5rem; margin-bottom: 1.5rem; text-align: center;">Add as many details to get an accurate price check</p>

      <form method="POST" action="/cards/${card.id}/edit">
        <div class="form-row">
          <div class="form-group">
            <label for="name">Card Name *</label>
            <input type="text" id="name" name="name" placeholder="e.g., Zekrom ex SIR" value="${card.name}" required>
          </div>

          <div class="form-group">
            <label for="set_name">Set Name</label>
            <input type="text" id="set_name" name="set_name" value="${card.set_name || ''}">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="condition">Condition *</label>
            <select id="condition" name="condition" required>
              <option value="Mint" ${card.condition === 'Mint' ? 'selected' : ''}>Mint</option>
              <option value="Near Mint" ${card.condition === 'Near Mint' ? 'selected' : ''}>Near Mint</option>
              <option value="Lightly Played" ${card.condition === 'Lightly Played' ? 'selected' : ''}>Lightly Played</option>
              <option value="Moderately Played" ${card.condition === 'Moderately Played' ? 'selected' : ''}>Moderately Played</option>
              <option value="Heavily Played" ${card.condition === 'Heavily Played' ? 'selected' : ''}>Heavily Played</option>
              <option value="Damaged" ${card.condition === 'Damaged' ? 'selected' : ''}>Damaged</option>
            </select>
          </div>

          <div class="form-group">
            <label for="quantity">Quantity *</label>
            <input type="number" id="quantity" name="quantity" value="${card.quantity}" min="0" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="purchase_price">Purchase Price ($) (cost of sealed if pulled) *</label>
            <input type="number" id="purchase_price" name="purchase_price" step="0.01" min="0" value="${parseFloat(card.purchase_price).toFixed(2)}" required>
          </div>

          <div class="form-group">
            <label for="market_price">Market Price ($) *</label>
            <input type="number" id="market_price" name="market_price" step="0.01" min="0" value="${parseFloat(card.market_price).toFixed(2)}" required>
            <button type="button" id="check-ebay-price-btn" class="btn-small btn-price" style="margin-top: 0.5rem;">
              Check eBay Price
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="price_source">Price Source (optional)</label>
          <input type="text" id="price_source" name="price_source" value="${card.price_source || ''}" placeholder="e.g., TCGPlayer, eBay">
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <a href="/cards" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>

    <script>
      document.getElementById('check-ebay-price-btn').addEventListener('click', async function() {
        const btn = this;
        const name = document.getElementById('name').value.trim();
        const set_name = document.getElementById('set_name').value.trim();
        const condition = document.getElementById('condition').value;

        if (!name) {
          alert('Please enter a card name first');
          return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Checking...';

        try {
          const response = await fetch('/api/cards/preview-price', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, set_name, condition })
          });

          const data = await response.json();

          if (data.success) {
            alert('eBay Price Check (Active Listings):\\n\\n' +
                  'Average (USD): $' + data.data.averagePrice.toFixed(2) + '\\n' +
                  'Range (USD): $' + data.data.minPrice.toFixed(2) + ' - $' + data.data.maxPrice.toFixed(2) + '\\n' +
                  'Sample Size: ' + data.data.sampleSize + ' listings\\n\\n' +
                  'Use this as a reference for the Market Price field.');
          } else {
            alert(data.error || 'No eBay listings found for this item');
          }
        } catch (error) {
          console.error('Price check failed:', error);
          alert('Failed to check price. Please try again.');
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'Check eBay Price';
        }
      });
    </script>
  `
}) %>