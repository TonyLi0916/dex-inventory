<%- include('../layout', {
  title: title,
  body: `
    <div class="form-page">
      <h2>Edit Sealed Product</h2>
      <p style="font-size: 0.85rem; color: #94a3b8; margin-top: -0.5rem; margin-bottom: 1.5rem; text-align: center;">Add as many details to get an accurate price check</p>

      <form method="POST" action="/sealed/${sealed.id}/edit">
        <div class="form-row">
          <div class="form-group">
            <label for="product_name">Product Name *</label>
            <input type="text" id="product_name" name="product_name" value="${sealed.product_name}" required>
          </div>

          <div class="form-group">
            <label for="product_type">Product Type *</label>
            <select id="product_type" name="product_type" required>
              <option value="Booster Box" ${sealed.product_type === 'Booster Box' ? 'selected' : ''}>Booster Box</option>
              <option value="Elite Trainer Box" ${sealed.product_type === 'Elite Trainer Box' ? 'selected' : ''}>Elite Trainer Box</option>
              <option value="Tin" ${sealed.product_type === 'Tin' ? 'selected' : ''}>Tin</option>
              <option value="Collection Box" ${sealed.product_type === 'Collection Box' ? 'selected' : ''}>Collection Box</option>
              <option value="Booster Pack" ${sealed.product_type === 'Booster Pack' ? 'selected' : ''}>Booster Pack</option>
              <option value="Other" ${sealed.product_type === 'Other' ? 'selected' : ''}>Other</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="quantity">Quantity *</label>
            <input type="number" id="quantity" name="quantity" value="${sealed.quantity}" min="0" required>
          </div>

          <div class="form-group">
            <label for="purchase_price">Purchase Price ($) *</label>
            <input type="number" id="purchase_price" name="purchase_price" step="0.01" min="0" value="${parseFloat(sealed.purchase_price).toFixed(2)}" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="market_price">Market Price ($) *</label>
            <input type="number" id="market_price" name="market_price" step="0.01" min="0" value="${parseFloat(sealed.market_price).toFixed(2)}" required>
            <button type="button" id="check-ebay-price-btn" class="btn-small btn-price" style="margin-top: 0.5rem;">
              Check eBay Price
            </button>
          </div>

          <div class="form-group">
            <label for="price_source">Price Source (optional)</label>
            <input type="text" id="price_source" name="price_source" value="${sealed.price_source || ''}" placeholder="e.g., TCGPlayer, eBay">
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <a href="/sealed" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>

    <script>
      document.getElementById('check-ebay-price-btn').addEventListener('click', async function() {
        const btn = this;
        const product_name = document.getElementById('product_name').value.trim();
        const product_type = document.getElementById('product_type').value;

        if (!product_name) {
          alert('Please enter a product name first');
          return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Checking...';

        try {
          const response = await fetch('/api/sealeds/preview-price', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_name, product_type })
          });

          const data = await response.json();

          if (data.success) {
            alert('eBay Price Check (Active Listings):\\n\\n' +
                  'Average: $' + data.data.averagePrice.toFixed(2) + '\\n' +
                  'Range: $' + data.data.minPrice.toFixed(2) + ' - $' + data.data.maxPrice.toFixed(2) + '\\n' +
                  'Sample Size: ' + data.data.sampleSize + ' listings\\n\\n' +
                  'Use this as a reference for the Market Price field.');
          } else {
            alert(data.error || 'No eBay listings found for this item');
          }
        } catch (error) {
          console.error('Price check failed:', error);
          alert('Failed to check price. Please try again.');
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'Check eBay Price';
        }
      });
    </script>
  `
}) %>